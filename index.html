<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TITAN åˆ©ç›Šè¨ˆç®— v3.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'IBM Plex Sans JP','Hiragino Kaku Gothic ProN',sans-serif;background:#f5f5f0;color:#1a1a1a;font-size:14px;line-height:1.6}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#eee}::-webkit-scrollbar-thumb{background:#bbb;border-radius:3px}
.hdr{background:#fff;border-bottom:2px solid #1a1a1a;padding:12px 24px;display:flex;align-items:center;gap:14px;position:sticky;top:0;z-index:100}
.hdr-mark{font-size:22px;font-weight:800;letter-spacing:.06em;font-family:'IBM Plex Mono',monospace}
.hdr-sub{font-size:11px;color:#888;margin-top:1px;letter-spacing:.02em}
.wrap{max-width:1040px;margin:0 auto;padding:20px 16px 80px}
.tabs{display:flex;gap:0;border-bottom:2px solid #1a1a1a;margin-bottom:24px;background:#fff}
.tab{flex:1;padding:12px 8px;border:none;cursor:pointer;background:transparent;color:#888;font-size:13px;font-weight:600;transition:all .15s;border-bottom:2px solid transparent;font-family:inherit;text-align:center}
.tab.on{color:#1a1a1a;border-bottom-color:#1a1a1a;background:#fafaf5}
.tab:hover:not(.on){color:#555;background:#fafaf8}
.tab .num{display:inline-block;background:#eee;padding:0 7px;border-radius:3px;font-size:11px;margin-left:4px;font-family:'IBM Plex Mono',monospace}
.tab.on .num{background:#1a1a1a;color:#fff}
.pnl{display:none}.pnl.on{display:block}
.cd{background:#fff;border:1px solid #ddd;margin-bottom:16px;padding:20px}
.cd-t{font-size:13px;font-weight:700;margin-bottom:14px;padding-bottom:8px;border-bottom:1px solid #eee;text-transform:uppercase;letter-spacing:.06em;color:#555}
label{display:block;font-size:11px;font-weight:600;color:#888;margin-bottom:3px;text-transform:uppercase;letter-spacing:.04em}
input,select,textarea{width:100%;padding:8px 10px;border:1px solid #ccc;background:#fff;color:#1a1a1a;font-size:13px;font-family:'IBM Plex Mono',monospace;outline:none;transition:border .15s}
input:focus,select:focus,textarea:focus{border-color:#1a1a1a}
.row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1;min-width:160px}
.btn{padding:10px 22px;border:2px solid #1a1a1a;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;text-transform:uppercase;letter-spacing:.04em}
.btn-p{background:#1a1a1a;color:#fff}.btn-p:hover{background:#333}.btn-p:disabled{opacity:.3;cursor:default}
.btn-s{background:#fff;color:#1a1a1a}.btn-s:hover{background:#f0f0ea}
.btn-d{border-color:#c44;color:#c44;background:#fff}.btn-d:hover{background:#fef5f5}
.btn-w{width:100%;text-align:center;padding:14px}
.drop{border:2px dashed #bbb;padding:40px;text-align:center;cursor:pointer;transition:all .15s;background:#fafaf5}
.drop:hover,.drop.over{border-color:#1a1a1a;background:#f5f5f0}
.drop-ic{font-size:28px;margin-bottom:6px;opacity:.6}.drop-tx{color:#888;font-size:12px}
.tw{overflow-x:auto;border:1px solid #ddd}
table{width:100%;border-collapse:collapse;font-size:12px;font-family:'IBM Plex Mono',monospace}
th{padding:8px 10px;text-align:left;font-size:10px;font-weight:700;background:#f5f5f0;border-bottom:2px solid #1a1a1a;text-transform:uppercase;letter-spacing:.06em;color:#888;white-space:nowrap}
td{padding:7px 10px;border-bottom:1px solid #eee;white-space:nowrap;max-width:220px;overflow:hidden;text-overflow:ellipsis}
tr:hover td{background:#fafaf5}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.st{background:#fff;border:1px solid #ddd;padding:16px;text-align:center}
.st-l{font-size:10px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.st-v{font-size:20px;font-weight:700;font-family:'IBM Plex Mono',monospace}
.sr{background:#fff;border:1px solid #ddd;margin-bottom:6px;transition:border-color .15s}
.sr:hover{border-color:#aaa}
.sr-h{padding:10px 16px;cursor:pointer;display:flex;align-items:center;gap:12px}
.sr-nm{flex:1;min-width:0}
.sr-nm-t{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sr-nm-s{font-size:11px;color:#888;margin-top:1px}
.sr-n{display:flex;gap:18px;flex-shrink:0;font-family:'IBM Plex Mono',monospace}
.sr-n>div{text-align:right}
.sr-nl{font-size:9px;color:#888;text-transform:uppercase;letter-spacing:.04em}
.sr-nv{font-size:13px;font-weight:600}
.sr-d{padding:0 16px 16px;border-top:1px solid #eee;display:none}
.pg{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
.pc{background:#f8f8f3;padding:8px;border:1px solid #e5e5e0}
.pc.miss{border-color:#d99}
.pc.opt{border-color:#8b8;background:#f5faf5}
.pc-l{font-size:9px;color:#888;text-transform:uppercase;letter-spacing:.04em;margin-bottom:3px}
.pc-n{font-size:11px;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pc input{padding:5px 6px;font-size:11px}
.al{padding:12px 16px;margin-bottom:14px;border-left:4px solid}
.al-w{background:#fffbe6;border-color:#e6a800;color:#8a6d00}
.al-e{background:#fff0f0;border-color:#c44;color:#922}
.al-s{background:#f0f8f0;border-color:#4a4;color:#264}
.al h4{font-size:12px;margin-bottom:4px}.al p{font-size:11px;opacity:.8}
.tag{display:inline-block;padding:2px 8px;font-size:11px;margin:2px 3px 2px 0;border:1px solid}
.tag-m{border-color:#d99;color:#922;background:#fff0f0}
.tag-o{border-color:#ccc;color:#666;background:#f8f8f3}
.tag-g{border-color:#9c9;color:#264;background:#f0f8f0}
.prog{width:100%;height:4px;background:#e5e5e0;margin:10px 0}
.prog-f{height:100%;background:#1a1a1a;transition:width .3s}
.mono{font-family:'IBM Plex Mono',monospace}
.red{color:#c44}.grn{color:#2a7a2a}.ylw{color:#b08800}
.mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}
.fx{display:flex;gap:10px;flex-wrap:wrap}.fx-c{align-items:center}
.tbl-edit{margin-top:10px}
.tbl-edit td{padding:4px 6px}
.tbl-edit input{padding:4px 6px;font-size:11px;width:80px;text-align:right}
.tbl-edit .gpu-name{font-weight:600;font-size:12px}
@media(max-width:768px){
  .stats{grid-template-columns:repeat(2,1fr)}
  .pg{grid-template-columns:repeat(2,1fr)}
  .sr-n{gap:10px}
  .row>*{min-width:120px}
}
</style>
</head>
<body>

<div class="hdr">
  <div>
    <div class="hdr-mark">TITAN</div>
    <div class="hdr-sub">åˆ©ç›Šè¨ˆç®—ãƒ„ãƒ¼ãƒ« v3.0 <span style="opacity:.5">/ 2026-02-15</span></div>
  </div>
</div>

<div class="wrap">
  <div class="tabs">
    <div class="tab on" onclick="go(0)">è¨­å®šãƒ»CSVå–è¾¼</div>
    <div class="tab" onclick="go(1)">AIè§£æ <span class="num" id="b1">0</span></div>
    <div class="tab" onclick="go(2)">ä¸è¶³ãƒ‘ãƒ¼ãƒ„ <span class="num" id="b2">0</span></div>
    <div class="tab" onclick="go(3)">å£²ä¸Šãƒ»å‡ºåŠ›</div>
  </div>

  <!-- ===== Panel 0: Settings ===== -->
  <div class="pnl on" id="p0">
    <div class="cd">
      <div class="cd-t">APIè¨­å®š <button class="btn btn-s" onclick="saveSettings()" style="padding:3px 10px;font-size:10px;float:right">è¨­å®šã‚’ä¿å­˜</button></div>
      <div class="row">
        <div style="flex:3"><label>OpenAI API Key</label><input type="password" id="apiKey" placeholder="sk-..."></div>
        <div style="flex:1"><label>Model</label>
          <select id="mdl">
            <option value="gpt-4.1-mini">GPT-4.1 miniï¼ˆæ¨å¥¨ï¼‰</option>
            <option value="gpt-4.1-nano">GPT-4.1 nanoï¼ˆå®‰ã„ï¼‰</option>
          </select>
        </div>
      </div>
      <div class="mt8">
        <button class="btn btn-s" onclick="testAPI()" style="padding:6px 14px;font-size:11px">APIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
        <span id="apiTestResult" style="margin-left:10px;font-size:12px"></span>
      </div>
      <div class="row mt12">
        <div><label>é€æ–™ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ Â¥</label><input type="number" id="defShip" value="1500"></div>
        <div><label>æ‰‹æ•°æ–™ç‡ %</label><input type="number" id="feeRate" value="10"></div>
      </div>
    </div>

    <div class="cd">
      <div class="cd-t">æ¶ˆè²»ç¨è¨­å®š</div>
      <div class="row">
        <div><label>æ¶ˆè²»ç¨</label>
          <select id="taxMode" onchange="taxModeChange()">
            <option value="off">ãªã—</option>
            <option value="simple" selected>ç°¡æ˜“èª²ç¨</option>
            <option value="standard">æœ¬å‰‡èª²ç¨</option>
          </select>
        </div>
        <div id="taxSimpleWrap"><label>äº‹æ¥­åŒºåˆ†ï¼ˆç°¡æ˜“èª²ç¨ï¼‰</label>
          <select id="taxSimpleCat">
            <option value="90">ç¬¬1ç¨® å¸å£²æ¥­ 90%</option>
            <option value="80" selected>ç¬¬2ç¨® å°å£²æ¥­ 80%</option>
            <option value="70">ç¬¬3ç¨® è£½é€ æ¥­ 70%</option>
            <option value="60">ç¬¬4ç¨® ãã®ä»– 60%</option>
            <option value="50">ç¬¬5ç¨® ã‚µãƒ¼ãƒ“ã‚¹æ¥­ 50%</option>
          </select>
        </div>
        <div id="taxStdWrap" style="display:none"><label>ã‚¤ãƒ³ãƒœã‚¤ã‚¹ä»•å…¥ç¨ç‡ %</label><input type="number" id="taxInputRate" value="100"></div>
      </div>
      <div class="mt8" style="font-size:11px;color:#888" id="taxDesc">ç°¡æ˜“èª²ç¨: æ¶ˆè²»ç¨é¡ = å£²ä¸Šç¨é¡ Ã—ï¼ˆ1 - ã¿ãªã—ä»•å…¥ç‡ï¼‰</div>
    </div>

    <div class="cd">
      <div class="cd-t">åŸä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«
        <button class="btn btn-s" onclick="saveAllTables()" style="padding:3px 10px;font-size:10px;float:right">å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¿å­˜</button>
      </div>

      <!-- GPU Base Table -->
      <details open>
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ GPUãƒ™ãƒ¼ã‚¹åŸä¾¡ï¼ˆGPUã§å…¨ãƒ‘ãƒ¼ãƒ„ã®ãƒ™ãƒ¼ã‚¹åŸä¾¡ãŒæ±ºã¾ã‚‹ï¼‰</summary>
        <div class="tw" style="max-height:400px;overflow-y:auto">
          <table class="tbl-edit" id="gpuTableEdit">
            <thead><tr>
              <th>GPUå‹ç•ª</th><th>ã‚°ãƒ©ãƒœ</th><th>CPU</th><th>MB</th><th>RAM</th><th>SSD</th><th>ã‚±ãƒ¼ã‚¹</th><th>é›»æº</th><th>ã‚¯ãƒ¼ãƒ©ãƒ¼</th><th>åˆè¨ˆ</th><th></th>
            </tr></thead>
            <tbody id="gpuTbody"></tbody>
          </table>
        </div>
        <div class="fx mt8">
          <input type="text" id="newGpuName" placeholder="æ–°GPUå‹ç•ªï¼ˆä¾‹: RTX5080ï¼‰" style="width:200px">
          <button class="btn btn-s" onclick="addGpuRow()" style="padding:4px 12px;font-size:11px">GPUè¿½åŠ </button>
        </div>
      </details>

      <!-- CPU Prices -->
      <details class="mt12">
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ CPUä¾¡æ ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´æ™‚ã®åŸä¾¡ï¼‰</summary>
        <div class="tw">
          <table class="tbl-edit"><thead><tr><th>CPUå</th><th>åŸä¾¡ Â¥</th><th></th></tr></thead>
            <tbody id="cpuTbody"></tbody>
          </table>
        </div>
        <div class="fx mt8">
          <input type="text" id="newCpuName" placeholder="CPUåï¼ˆä¾‹: 5800X3Dï¼‰" style="width:160px">
          <input type="number" id="newCpuPrice" placeholder="åŸä¾¡" style="width:100px">
          <button class="btn btn-s" onclick="addPartRow('cpu')" style="padding:4px 12px;font-size:11px">è¿½åŠ </button>
        </div>
      </details>

      <!-- RAM Prices -->
      <details class="mt12">
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ RAMä¾¡æ ¼</summary>
        <div class="tw">
          <table class="tbl-edit"><thead><tr><th>RAM</th><th>åŸä¾¡ Â¥</th><th></th></tr></thead>
            <tbody id="ramTbody"></tbody>
          </table>
        </div>
        <div class="fx mt8">
          <input type="text" id="newRamName" placeholder="åç§°ï¼ˆä¾‹: 64GB DDR5ï¼‰" style="width:160px">
          <input type="number" id="newRamPrice" placeholder="åŸä¾¡" style="width:100px">
          <button class="btn btn-s" onclick="addPartRow('ram')" style="padding:4px 12px;font-size:11px">è¿½åŠ </button>
        </div>
      </details>

      <!-- SSD Prices -->
      <details class="mt12">
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ SSDä¾¡æ ¼</summary>
        <div class="tw">
          <table class="tbl-edit"><thead><tr><th>SSD</th><th>åŸä¾¡ Â¥</th><th></th></tr></thead>
            <tbody id="ssdTbody"></tbody>
          </table>
        </div>
        <div class="fx mt8">
          <input type="text" id="newSsdName" placeholder="åç§°ï¼ˆä¾‹: 4TBï¼‰" style="width:160px">
          <input type="number" id="newSsdPrice" placeholder="åŸä¾¡" style="width:100px">
          <button class="btn btn-s" onclick="addPartRow('ssd')" style="padding:4px 12px;font-size:11px">è¿½åŠ </button>
        </div>
      </details>

      <!-- Case Prices -->
      <details class="mt12">
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ ã‚±ãƒ¼ã‚¹ä¾¡æ ¼</summary>
        <div class="tw">
          <table class="tbl-edit"><thead><tr><th>ã‚±ãƒ¼ã‚¹å</th><th>åŸä¾¡ Â¥</th><th></th></tr></thead>
            <tbody id="casTbody"></tbody>
          </table>
        </div>
        <div class="fx mt8">
          <input type="text" id="newCasName" placeholder="åç§°ï¼ˆä¾‹: DS900WHï¼‰" style="width:160px">
          <input type="number" id="newCasPrice" placeholder="åŸä¾¡" style="width:100px">
          <button class="btn btn-s" onclick="addPartRow('cas')" style="padding:4px 12px;font-size:11px">è¿½åŠ </button>
        </div>
      </details>

      <!-- Option Prices -->
      <details class="mt12">
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¾¡æ ¼ï¼ˆæ°´å†·ãƒ»WiFiç­‰ï¼‰</summary>
        <div class="tw">
          <table class="tbl-edit"><thead><tr><th>ã‚ªãƒ—ã‚·ãƒ§ãƒ³å</th><th>åŸä¾¡ Â¥</th><th></th></tr></thead>
            <tbody id="optTbody"></tbody>
          </table>
        </div>
        <div class="fx mt8">
          <input type="text" id="newOptName" placeholder="åç§°ï¼ˆä¾‹: 360mmæ°´å†·ï¼‰" style="width:160px">
          <input type="number" id="newOptPrice" placeholder="åŸä¾¡" style="width:100px">
          <button class="btn btn-s" onclick="addPartRow('other')" style="padding:4px 12px;font-size:11px">è¿½åŠ </button>
        </div>
      </details>

      <!-- Peripheral Fixed Prices -->
      <details class="mt12">
        <summary style="font-size:12px;font-weight:700;cursor:pointer;margin-bottom:8px">â–¼ å‘¨è¾ºæ©Ÿå™¨ï¼ˆå›ºå®šä¾¡æ ¼ï¼‰</summary>
        <div class="row">
          <div><label>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ Â¥</label><input type="number" id="fixKb" value="1500" onchange="fixedPrices.keyboard=parseInt(this.value)||0"></div>
          <div><label>ãƒã‚¦ã‚¹ Â¥</label><input type="number" id="fixMouse" value="1000" onchange="fixedPrices.mouse=parseInt(this.value)||0"></div>
          <div><label>ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆé€šå¸¸ï¼‰Â¥</label><input type="number" id="fixMon" value="3000" onchange="fixedPrices.monitor=parseInt(this.value)||0"></div>
          <div><label>ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆ144hzï¼‰Â¥</label><input type="number" id="fixMon144" value="8000" onchange="fixedPrices.monitor144hz=parseInt(this.value)||0"></div>
        </div>
      </details>
    </div>

    <div class="cd">
      <div class="cd-t">CSVå–è¾¼</div>
      <div class="al al-w">
        <h4>æ³¨æ„</h4>
        <p>äº‹å‹™å±€ã«ã‚ˆã£ã¦å¯¾å¿œã•ã‚ŒãŸå•†å“ã¯èª­ã¿å–ã‚Šã§ãã¾ã›ã‚“ã€‚å¿…ãšæ‰‹å‹•ã§è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
      <div class="drop" id="dz" onclick="$('csvF').click()" ondragover="event.preventDefault();this.classList.add('over')" ondragleave="this.classList.remove('over')" ondrop="onDrop(event)">
        <div class="drop-ic">â†‘</div>
        <div class="drop-tx">ãƒ¡ãƒ«ã‚«ãƒªCSVã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— / ã‚¯ãƒªãƒƒã‚¯<br><span style="font-size:10px;color:#aaa">â€»Shift-JIS(cp932)ã§è‡ªå‹•èª­è¾¼</span></div>
        <input type="file" id="csvF" accept=".csv" hidden onchange="onFile(event)">
      </div>
      <div id="csvUI" style="display:none">
        <div class="al al-s" id="csvSt"></div>
        <div class="row mb12">
          <div><label>å•†å“å</label><select id="cN"></select></div>
          <div><label>èª¬æ˜æ–‡</label><select id="cD"></select></div>
          <div><label>ä¾¡æ ¼</label><select id="cP"></select></div>
          <div><label>æ—¥ä»˜</label><select id="cDt"></select></div>
        </div>
        <div class="row mb12">
          <div><label>å‡ºå“çŠ¶æ³ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ï¼‰</label><select id="cSt"></select></div>
          <div style="display:flex;align-items:flex-end;padding-bottom:1px">
            <label style="display:inline;margin:0"><input type="checkbox" id="soldOnly" checked> å£²å´æ¸ˆã®ã¿å–è¾¼</label>
          </div>
        </div>
        <div class="fx mb12">
          <button class="btn btn-s" onclick="reRead('utf-8')">UTF-8ã§å†èª­è¾¼</button>
          <button class="btn btn-s" onclick="reRead('shift_jis')">Shift-JISã§å†èª­è¾¼</button>
        </div>
        <div class="tw" style="max-height:180px;overflow-y:auto" id="csvPv"></div>
      </div>
    </div>

    <div class="cd">
      <div class="cd-t">å¼•ãç¶™ã</div>
      <p style="font-size:11px;color:#888;margin-bottom:10px">â€»localStorageã¯HTMLæ›´æ–°ã§ã¯æ¶ˆãˆã¾ã›ã‚“ã€‚åˆ¥ç«¯æœ«ã«ç§»è¡Œã™ã‚‹å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«æ›¸å‡ºã—ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</p>
      <div style="font-size:12px;font-weight:600;margin-bottom:6px">åŸä¾¡ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šï¼ˆGPUãƒ»CPUãƒ»RAMãƒ»SSDãƒ»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»å‘¨è¾ºæ©Ÿå™¨ï¼‰</div>
      <div class="fx mb12">
        <button class="btn btn-s" onclick="exportTables()">ãƒ†ãƒ¼ãƒ–ãƒ«æ›¸å‡ºã—</button>
        <button class="btn btn-s" onclick="$('impTblF').click()">ãƒ†ãƒ¼ãƒ–ãƒ«èª­è¾¼</button>
        <input type="file" id="impTblF" accept=".json" hidden onchange="importTables(event)">
      </div>
      <div style="font-size:12px;font-weight:600;margin-bottom:6px">å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ï¼‹å£²ä¸Šï¼‹APIè¨­å®šï¼‰</div>
      <div class="fx mb12">
        <button class="btn btn-s" onclick="exportJSON()">å…¨ãƒ‡ãƒ¼ã‚¿æ›¸å‡ºã—</button>
        <button class="btn btn-s" onclick="$('impF').click()">å…¨ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
        <input type="file" id="impF" accept=".json" hidden onchange="importJSON(event)">
      </div>
      <div class="fx">
        <button class="btn btn-d" onclick="if(confirm('å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))clearSales()">å£²ä¸Šã®ã¿å‰Šé™¤</button>
        <button class="btn btn-d" onclick="if(confirm('å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å«ã‚€ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))clearAll()">å…¨å‰Šé™¤</button>
      </div>
    </div>

    <button class="btn btn-p btn-w mt16" id="btnGo" onclick="startAI()" disabled>AIè§£æé–‹å§‹</button>
  </div>

  <!-- ===== Panel 1: AI Parse ===== -->
  <div class="pnl" id="p1">

    <!-- URL Import -->
    <div class="cd">
      <div class="cd-t">ğŸ”— URLå–è¾¼</div>
      <div class="row fx-c">
        <div style="flex:1"><input type="text" id="urlInput" placeholder="ãƒ¡ãƒ«ã‚«ãƒªå•†å“URLã‚’è²¼ã‚Šä»˜ã‘ï¼ˆä¾‹: https://jp.mercari.com/item/m...ï¼‰"></div>
        <button class="btn btn-p" onclick="fetchURL()" id="btnURL" style="flex-shrink:0;white-space:nowrap">å–è¾¼+è§£æ</button>
      </div>
      <div id="urlSt" class="mt8" style="font-size:11px"></div>
    </div>

    <!-- Manual Entry -->
    <details class="cd" style="cursor:default">
      <summary style="font-size:11px;font-weight:700;cursor:pointer;text-transform:uppercase;letter-spacing:.06em;color:#555;padding-bottom:8px;border-bottom:1px solid #eee;margin-bottom:12px">âœï¸ æ‰‹å‹•è¿½åŠ </summary>
      <div class="row mb12">
        <div><label>å•†å“å</label><input type="text" id="manName" placeholder="ã‚²ãƒ¼ãƒŸãƒ³ã‚°PC RTX5070..."></div>
        <div><label>å£²å€¤ Â¥</label><input type="number" id="manPrice" placeholder="200000"></div>
        <div><label>æ—¥ã«ã¡</label><input type="text" id="manDate" placeholder="2026/02/15"></div>
      </div>
      <div class="mb12">
        <label>èª¬æ˜æ–‡ï¼ˆGPTè§£æã«ä½¿ç”¨ï¼‰</label>
        <textarea id="manDesc" rows="5" placeholder="ã‚¹ãƒšãƒƒã‚¯ã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å…¥åŠ›...&#10;ä¾‹: RTX5070æ­è¼‰ã€Ryzen 7 5700Xã€DDR4 32GBã€SSD 1TBã€ç°¡æ˜“æ°´å†·ä»˜ãã€ãƒ•ãƒ«ã‚»ãƒƒãƒˆ"></textarea>
      </div>
      <button class="btn btn-p" onclick="manualAdd()" id="btnMan">GPTè§£æã—ã¦è¿½åŠ </button>
      <div id="manSt" class="mt8" style="font-size:11px"></div>
    </details>

    <!-- Progress -->
    <div id="aiProg" style="display:none">
      <div class="cd">
        <div class="cd-t">è§£æä¸­...</div>
        <div class="prog"><div class="prog-f" id="pBar" style="width:0%"></div></div>
        <div class="fx fx-c mt8">
          <span class="mono" id="pTxt">0 / 0</span>
          <span style="font-size:11px;color:#888" id="pCur"></span>
        </div>
      </div>
    </div>
    <div id="aiRes" style="display:none">
      <div class="al al-s" id="aiSt"></div>
      <div id="aiList"></div>
    </div>
  </div>

  <!-- ===== Panel 2: Missing Parts ===== -->
  <div class="pnl" id="p2">
    <div id="missWrap"></div>
    <button class="btn btn-p btn-w mt16" onclick="applyMissing()">é©ç”¨ã—ã¦å£²ä¸Šã¸</button>
  </div>

  <!-- ===== Panel 3: Sales ===== -->
  <div class="pnl" id="p3">
    <div class="stats">
      <div class="st"><div class="st-l">ç·å£²ä¸Š</div><div class="st-v" id="s1">Â¥0</div></div>
      <div class="st"><div class="st-l">ç·åˆ©ç›Šï¼ˆç¨å¼•å¾Œï¼‰</div><div class="st-v grn" id="s2">Â¥0</div></div>
      <div class="st"><div class="st-l">å¹³å‡åˆ©ç›Šç‡</div><div class="st-v" id="s3">0%</div></div>
      <div class="st"><div class="st-l">æ¶ˆè²»ç¨åˆè¨ˆ</div><div class="st-v ylw" id="s4">Â¥0</div></div>
    </div>
    <div class="fx mb16">
      <button class="btn btn-p" onclick="toExcel()">EXCELå‡ºåŠ›</button>
      <button class="btn btn-s" onclick="go(0)">â† æ–°è¦CSVå–è¾¼</button>
    </div>
    <div id="salesList"></div>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const LS_CFG='titan_cfg_v2';
const LS_GPU='titan_gpu_v2';
const LS_SALES='titan_sales_v2';
const LS_OPT='titan_opt_v2';

// ================================================================
// GPU Base Cost Table (ã‚¤ãƒˆã‚¦ãƒ¡ãƒ«ã‚«ãƒªç”¨)
// ================================================================
const DEFAULT_GPU_TABLE={
  'RX9070XT':  {gpu:110000,cpu:23000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:7000,cool:300},
  'RX9060XT':  {gpu:50000, cpu:15000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:6000,cool:300},
  'RTX5070':   {gpu:105000,cpu:23000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:7000,cool:300},
  'RTX5070Ti': {gpu:165000,cpu:23000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:7000,cool:300},
  'RX9070':    {gpu:100000,cpu:23000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:7000,cool:300},
  'RTX5060Ti': {gpu:70000, cpu:23000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:7000,cool:300},
  'RTX4070Ti': {gpu:90000, cpu:15000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:1300,cool:300},
  'RTX3080':   {gpu:45000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:1300,cool:300},
  'RTX3070':   {gpu:28000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'RTX2080':   {gpu:20000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'RTX4060':   {gpu:35000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'RTX3060':   {gpu:32000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'GTX1080Ti': {gpu:8000,  cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'RTX4060Ti': {gpu:40000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'RTX3050':   {gpu:33000, cpu:15000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:6000,cool:300},
  'RTX5050':   {gpu:45000, cpu:15000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:6000,cool:300},
  'RTX5060':   {gpu:54000, cpu:15000,mb:4000,ram:8000,ssd:7000,cas:7000,psu:6000,cool:300},
  'RTX2060':   {gpu:13000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:700, cool:300},
  'RX7600':    {gpu:41000, cpu:3500, mb:4000,ram:8000,ssd:7000,cas:7000,psu:6000,cool:300},
};

// Option upgrade prices (editable)
const DEFAULT_OPT={
  cpu:{'1700':3500,'3700X':6000,'5700X':15000,'7700':23000,'700X':23000,'7700X':25000,'5900X':40000,'9800X3D':50000,'5600X':12000,'5600':10000},
  ram:{'DDR4 16GB':8000,'DDR4 32GB':12000,'DDR5 16GB':10000,'DDR5 32GB':15000,'DDR5 64GB':25000},
  ssd:{'512GB':7000,'1TB':10000,'2TB':15000},
  cas:{'æ–°å“ã‚±ãƒ¼ã‚¹â˜…':10000,'ç™½ã‚±ãƒ¼ã‚¹':7000,'é»’ã‚±ãƒ¼ã‚¹':4000,'ãƒ–ãƒ©ãƒƒã‚¯ã®ã‚±ãƒ¼ã‚¹':4000,'æ–°å“ã‚±ãƒ¼ã‚¹':7000,'CX200M':7000,'T4 PLUS':4000,'T4':4000,'H17':3500,'PIRAWH':8000,'DS900WH':10000,'DS900BK':10000,'CXWH':7000,'æ¹¾æ›²ãƒ”ãƒ¼ãƒ©ãƒ¼ãƒ¬ã‚¹ã‚¬ãƒ©ã‚¹ã‚±ãƒ¼ã‚¹':10000},
  other:{'ç°¡æ˜“æ°´å†·':5000,'æ¶²æ™¶ç°¡æ˜“æ°´å†·':8000,'120mmç©ºå†·ã‚¯ãƒ¼ãƒ©ãƒ¼':2000,'å†…è”µWiFi':2000,'USB WiFi':1000,'å†…è”µBluetooth':1000,'USB Bluetooth':500}
};
const DEFAULT_FIXED={keyboard:1500,mouse:1000,monitor:3000,monitor144hz:8000};

let optPrices=JSON.parse(JSON.stringify(DEFAULT_OPT));
let fixedPrices={...DEFAULT_FIXED};

let gpuTable=JSON.parse(JSON.stringify(DEFAULT_GPU_TABLE));
let sales=[];
let csvH=[],csvR=[],curFile=null;

// ================================================================
// GPU Table UI
// ================================================================
function renderGpuTable(){
  const cols=['gpu','cpu','mb','ram','ssd','cas','psu','cool'];
  let html='';
  for(const[k,v]of Object.entries(gpuTable)){
    const total=cols.reduce((s,c)=>s+(v[c]||0),0);
    html+=`<tr><td class="gpu-name">${esc(k)}</td>`;
    cols.forEach(c=>{html+=`<td><input type="number" value="${v[c]||0}" onchange="gpuTable['${k}'].${c}=parseInt(this.value)||0;renderGpuTable()"></td>`});
    html+=`<td class="mono" style="font-weight:600">Â¥${total.toLocaleString()}</td>`;
    html+=`<td><button onclick="delete gpuTable['${k}'];renderGpuTable()" style="border:none;color:#c44;cursor:pointer;font-size:14px;background:none">Ã—</button></td></tr>`;
  }
  $('gpuTbody').innerHTML=html;
}
function addGpuRow(){
  const name=$('newGpuName').value.trim();
  if(!name){alert('GPUå‹ç•ªã‚’å…¥åŠ›');return}
  if(gpuTable[name]){alert('æ—¢ã«å­˜åœ¨');return}
  gpuTable[name]={gpu:0,cpu:3500,mb:4000,ram:8000,ssd:7000,cas:7000,psu:700,cool:300};
  $('newGpuName').value='';renderGpuTable();
}

// ================================================================
// Parts Sub-table UI (CPU/RAM/SSD/Option)
// ================================================================
function renderPartTable(cat,tbodyId){
  const data=optPrices[cat]||{};
  let html='';
  for(const[k,v]of Object.entries(data)){
    html+=`<tr><td style="font-size:12px">${esc(k)}</td>`;
    html+=`<td><input type="number" value="${v}" onchange="optPrices['${cat}']['${k}']=parseInt(this.value)||0"></td>`;
    html+=`<td><button onclick="delete optPrices['${cat}']['${k}'];renderPartTable('${cat}','${tbodyId}')" style="border:none;color:#c44;cursor:pointer;font-size:14px;background:none">Ã—</button></td></tr>`;
  }
  $(tbodyId).innerHTML=html;
}
function addPartRow(cat){
  const nameId=cat==='other'?'newOptName':'new'+cat.charAt(0).toUpperCase()+cat.slice(1)+'Name';
  const priceId=cat==='other'?'newOptPrice':'new'+cat.charAt(0).toUpperCase()+cat.slice(1)+'Price';
  const name=$(nameId).value.trim();
  const price=parseInt($(priceId).value)||0;
  if(!name){alert('åç§°ã‚’å…¥åŠ›');return}
  if(!optPrices[cat])optPrices[cat]={};
  optPrices[cat][name]=price;
  $(nameId).value='';$(priceId).value='';
  renderAllPartTables();
}
function renderAllPartTables(){
  renderPartTable('cpu','cpuTbody');
  renderPartTable('ram','ramTbody');
  renderPartTable('ssd','ssdTbody');
  renderPartTable('cas','casTbody');
  renderPartTable('other','optTbody');
}

// ================================================================
// Save/Load All Tables
// ================================================================
function saveAllTables(){
  localStorage.setItem(LS_GPU,JSON.stringify(gpuTable));
  localStorage.setItem(LS_OPT,JSON.stringify(optPrices));
  localStorage.setItem('titan_fixed_v2',JSON.stringify(fixedPrices));
  alert('å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¿å­˜å®Œäº†');
}
function loadAllTables(){
  try{const g=JSON.parse(localStorage.getItem(LS_GPU));if(g)gpuTable=g}catch{}
  try{const o=JSON.parse(localStorage.getItem(LS_OPT));if(o)optPrices=o}catch{}
  ensureSubTables();
  try{const f=JSON.parse(localStorage.getItem('titan_fixed_v2'));if(f){fixedPrices=f;$('fixKb').value=f.keyboard||1500;$('fixMouse').value=f.mouse||1000;$('fixMon').value=f.monitor||3000;$('fixMon144').value=f.monitor144hz||8000}}catch{}
}

// ================================================================
// GPU Matching
// ================================================================
function matchGpu(gpuName){
  if(!gpuName)return null;
  const n=gpuName.toUpperCase().replace(/\s+/g,'').replace(/GEFORCE/i,'').replace(/RADEON/i,'').trim();
  // Sort by key length descending to match longest first (RTX4060Ti before RTX4060)
  const keys=Object.keys(gpuTable).sort((a,b)=>b.length-a.length);
  for(const k of keys){
    if(n.includes(k.toUpperCase().replace(/\s+/g,'')))return k;
  }
  return null;
}

// ================================================================
// Option cost calculation (with missing detection)
// ================================================================
function calcOptionCost(optionStr){
  if(!optionStr)return {cost:0,miss:[]};
  let total=0;const miss=[];
  const items=optionStr.split(/[,ã€ï¼Œ]/);
  for(let item of items){
    item=item.trim();if(!item)continue;
    let found=false;
    const sortedKeys=Object.keys(optPrices.other||{}).sort((a,b)=>b.length-a.length);
    for(const k of sortedKeys){
      if(item.toLowerCase().includes(k.toLowerCase())){total+=optPrices.other[k];found=true;break}
    }
    if(!found)miss.push({cat:'option',name:item,note:'ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²'});
  }
  return {cost:total,miss};
}

function getCpuCost(cpuName,baseCost){
  if(!cpuName)return {cost:baseCost,matched:true};
  const n=cpuName.toUpperCase().replace(/RYZEN\s*(7|9|5)\s*/i,'').replace(/CORE\s*I\d\s*/i,'').trim();
  const keys=Object.keys(optPrices.cpu||{}).sort((a,b)=>b.length-a.length);
  for(const k of keys){
    if(n.includes(k.toUpperCase()))return {cost:optPrices.cpu[k],matched:true};
  }
  return {cost:baseCost,matched:false};
}

function getRamCost(ramStr,baseCost){
  if(!ramStr)return {cost:baseCost,matched:true};
  const n=ramStr.toUpperCase().replace(/\s+/g,' ').trim();
  const is5=n.includes('DDR5');
  if(n.includes('64')&&optPrices.ram?.['DDR5 64GB']!=null)return {cost:optPrices.ram['DDR5 64GB'],matched:true};
  if(n.includes('32')){
    const key=is5?'DDR5 32GB':'DDR4 32GB';
    if(optPrices.ram?.[key]!=null)return {cost:optPrices.ram[key],matched:true};
  }
  if(n.includes('16')){
    const key=is5?'DDR5 16GB':'DDR4 16GB';
    if(optPrices.ram?.[key]!=null)return {cost:optPrices.ram[key],matched:true};
  }
  return {cost:baseCost,matched:false};
}

function getSsdCost(ssdStr,baseCost){
  if(!ssdStr)return {cost:baseCost,matched:true};
  const n=ssdStr.toUpperCase();
  if(n.includes('2TB')&&optPrices.ssd?.['2TB']!=null)return {cost:optPrices.ssd['2TB'],matched:true};
  if(n.includes('1TB')&&optPrices.ssd?.['1TB']!=null)return {cost:optPrices.ssd['1TB'],matched:true};
  if(n.includes('512')&&optPrices.ssd?.['512GB']!=null)return {cost:optPrices.ssd['512GB'],matched:true};
  return {cost:baseCost,matched:false};
}

// ================================================================
// Full cost calculation for a sale
// ================================================================
function calcCosts(parts,gpuKey){
  const base=gpuKey?gpuTable[gpuKey]:null;
  const costs={};
  const missing=[];

  if(base){
    costs.gpu=base.gpu;

    const cpuR=getCpuCost(parts.cpu,base.cpu);
    costs.cpu=cpuR.cost;
    if(!cpuR.matched&&parts.cpu)missing.push({cat:'cpu',name:parts.cpu,note:'CPUãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²'});

    costs.mb=base.mb;

    const ramR=getRamCost(parts.ram,base.ram);
    costs.ram=ramR.cost;
    if(!ramR.matched&&parts.ram)missing.push({cat:'ram',name:parts.ram,note:'RAMãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²'});

    const ssdR=getSsdCost(parts.ssd,base.ssd);
    costs.ssd=ssdR.cost;
    if(!ssdR.matched&&parts.ssd)missing.push({cat:'ssd',name:parts.ssd,note:'SSDãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²'});

    // Case: if GPT returned a case name, look up in case table
    if(parts.case_name){
      const casTable=optPrices.cas||{};
      const casKeys=Object.keys(casTable).sort((a,b)=>b.length-a.length);
      let casMatched=false;
      for(const k of casKeys){
        if(parts.case_name.toLowerCase().includes(k.toLowerCase())){costs.cas=casTable[k];casMatched=true;break}
      }
      if(!casMatched){costs.cas=base.cas;missing.push({cat:'cas',name:parts.case_name,note:'ã‚±ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²'})}
    }else{costs.cas=base.cas}

    costs.psu=base.psu;
    costs.cool=base.cool;
  } else {
    costs.gpu=0;costs.cpu=0;costs.mb=4000;costs.ram=8000;costs.ssd=7000;costs.cas=7000;costs.psu=0;costs.cool=300;
    if(parts.gpu)missing.push({cat:'gpu',name:parts.gpu,note:'GPUãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²'});
  }

  const optR=calcOptionCost(parts.option);
  costs.option=optR.cost;
  missing.push(...optR.miss);

  // Peripherals
  if(parts.monitor){
    const mon=parts.monitor.toUpperCase();
    costs.monitor=(mon.includes('144')||mon.includes('165')||mon.includes('240'))?fixedPrices.monitor144hz:fixedPrices.monitor;
  }else{costs.monitor=0}
  costs.keyboard=(parts.keyboard)?fixedPrices.keyboard+fixedPrices.mouse:0;

  return {costs,missing};
}

function totalCost(costs){
  return Object.values(costs).reduce((s,v)=>s+(v||0),0);
}

// ================================================================
// Profit & Tax
// ================================================================
function calcTax(salePrice,costTotal,feeAmt,shipping){
  const mode=$('taxMode').value;
  if(mode==='off')return 0;
  if(mode==='simple'){
    const rate=parseInt($('taxSimpleCat').value)||80;
    const outputTax=Math.floor(salePrice/1.1*0.1);
    return Math.floor(outputTax*(1-rate/100));
  }
  // standard
  const outputTax=Math.floor(salePrice/1.1*0.1);
  const inputRate=(parseInt($('taxInputRate').value)||100)/100;
  const inputTax=Math.floor((costTotal+feeAmt+shipping)/1.1*0.1*inputRate);
  return Math.max(0,outputTax-inputTax);
}

function calcProfit(s){
  const fee=Math.floor(s.sale_price*s.fee_rate);
  const costT=totalCost(s.costs);
  const tax=calcTax(s.sale_price,costT,fee,s.shipping);
  return {fee,costTotal:costT,tax,profit:s.sale_price-costT-fee-s.shipping-tax,profitRate:s.sale_price>0?((s.sale_price-costT-fee-s.shipping-tax)/s.sale_price):0};
}

// ================================================================
// Settings
// ================================================================
function saveSettings(){
  const cfg={apiKey:$('apiKey').value,model:$('mdl').value,defShip:$('defShip').value,feeRate:$('feeRate').value,taxMode:$('taxMode').value,taxSimpleCat:$('taxSimpleCat').value,taxInputRate:$('taxInputRate').value};
  localStorage.setItem(LS_CFG,JSON.stringify(cfg));alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}
function loadSettings(){
  try{const c=JSON.parse(localStorage.getItem(LS_CFG));if(!c)return;
  if(c.apiKey)$('apiKey').value=c.apiKey;if(c.model)$('mdl').value=c.model;
  if(c.defShip)$('defShip').value=c.defShip;if(c.feeRate)$('feeRate').value=c.feeRate;
  if(c.taxMode){$('taxMode').value=c.taxMode;taxModeChange()}
  if(c.taxSimpleCat)$('taxSimpleCat').value=c.taxSimpleCat;
  if(c.taxInputRate)$('taxInputRate').value=c.taxInputRate;}catch{}
}
function taxModeChange(){
  const m=$('taxMode').value;
  $('taxSimpleWrap').style.display=m==='simple'?'':'none';
  $('taxStdWrap').style.display=m==='standard'?'':'none';
  $('taxDesc').textContent=m==='off'?'æ¶ˆè²»ç¨è¨ˆç®—ãªã—':m==='simple'?'ç°¡æ˜“èª²ç¨: æ¶ˆè²»ç¨é¡ = å£²ä¸Šç¨é¡ Ã—ï¼ˆ1 - ã¿ãªã—ä»•å…¥ç‡ï¼‰':'æœ¬å‰‡èª²ç¨: å£²ä¸Šç¨é¡ - ä»•å…¥ç¨é¡';
}

// ================================================================
// Storage
// ================================================================
function saveS(){localStorage.setItem(LS_SALES,JSON.stringify(sales))}
function loadS(){try{sales=JSON.parse(localStorage.getItem(LS_SALES))||[]}catch{sales=[]}}
function clearAll(){sales=[];saveS();localStorage.removeItem(LS_GPU);localStorage.removeItem(LS_OPT);localStorage.removeItem('titan_fixed_v2');gpuTable=JSON.parse(JSON.stringify(DEFAULT_GPU_TABLE));optPrices=JSON.parse(JSON.stringify(DEFAULT_OPT));fixedPrices={...DEFAULT_FIXED};renderGpuTable();renderAllPartTables();$('fixKb').value=1500;$('fixMouse').value=1000;$('fixMon').value=3000;$('fixMon144').value=8000;renderSales();$('b1').textContent=0;$('b2').textContent=0}
function clearSales(){sales=[];saveS();renderSales();$('b1').textContent=0;$('b2').textContent=0}
function exportJSON(){
  const d={type:'full',gpuTable,optPrices,fixedPrices,sales,settings:JSON.parse(localStorage.getItem(LS_CFG)||'{}'),exported:new Date().toISOString()};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`titan_full_${new Date().toISOString().slice(0,10)}.json`;a.click();
}
function exportTables(){
  const d={type:'tables',gpuTable,optPrices,fixedPrices,exported:new Date().toISOString()};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`titan_tables_${new Date().toISOString().slice(0,10)}.json`;a.click();
}
function ensureSubTables(){
  ['cpu','ram','ssd','cas','other'].forEach(k=>{if(!optPrices[k])optPrices[k]={...DEFAULT_OPT[k]}});
}
function importTables(e){
  const f=e.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=()=>{try{const d=JSON.parse(r.result);
    if(d.gpuTable){gpuTable=d.gpuTable;localStorage.setItem(LS_GPU,JSON.stringify(gpuTable));renderGpuTable()}
    if(d.optPrices){optPrices=d.optPrices;ensureSubTables();localStorage.setItem(LS_OPT,JSON.stringify(optPrices));renderAllPartTables()}
    if(d.fixedPrices){fixedPrices=d.fixedPrices;localStorage.setItem('titan_fixed_v2',JSON.stringify(fixedPrices));$('fixKb').value=fixedPrices.keyboard||1500;$('fixMouse').value=fixedPrices.mouse||1000;$('fixMon').value=fixedPrices.monitor||3000;$('fixMon144').value=fixedPrices.monitor144hz||8000}
    alert('ãƒ†ãƒ¼ãƒ–ãƒ«èª­è¾¼å®Œäº†');}catch(e){alert('ã‚¨ãƒ©ãƒ¼: '+e.message)}};
  r.readAsText(f);e.target.value='';
}
function importJSON(e){
  const f=e.target.files[0];if(!f)return;const r=new FileReader();
  r.onload=()=>{try{const d=JSON.parse(r.result);
    if(d.gpuTable){gpuTable=d.gpuTable;localStorage.setItem(LS_GPU,JSON.stringify(gpuTable));renderGpuTable()}
    if(d.optPrices){optPrices=d.optPrices;ensureSubTables();localStorage.setItem(LS_OPT,JSON.stringify(optPrices));renderAllPartTables()}
    if(d.fixedPrices){fixedPrices=d.fixedPrices;localStorage.setItem('titan_fixed_v2',JSON.stringify(fixedPrices));$('fixKb').value=fixedPrices.keyboard||1500;$('fixMouse').value=fixedPrices.mouse||1000;$('fixMon').value=fixedPrices.monitor||3000;$('fixMon144').value=fixedPrices.monitor144hz||8000}
    if(d.sales){sales=d.sales;saveS()}
    if(d.settings){localStorage.setItem(LS_CFG,JSON.stringify(d.settings));loadSettings()}
    renderSales();alert('èª­è¾¼å®Œäº†');}catch(e){alert('ã‚¨ãƒ©ãƒ¼: '+e.message)}};
  r.readAsText(f);e.target.value='';
}

// ================================================================
// Tabs
// ================================================================
function go(n){
  document.querySelectorAll('.tab').forEach((t,i)=>t.classList.toggle('on',i===n));
  document.querySelectorAll('.pnl').forEach((p,i)=>p.classList.toggle('on',i===n));
  if(n===2)renderMissing();
  if(n===3)renderSales();
}

// ================================================================
// CSV
// ================================================================
function onDrop(e){e.preventDefault();e.currentTarget.classList.remove('over');const f=e.dataTransfer.files[0];if(f){curFile=f;readCSV(f,'shift_jis')}}
function onFile(e){const f=e.target.files[0];if(f){curFile=f;readCSV(f,'shift_jis')}}
function reRead(enc){if(curFile)readCSV(curFile,enc)}
function readCSV(file,enc){
  const r=new FileReader();
  r.onload=()=>{
    const lines=r.result.split(/\r?\n/).filter(l=>l.trim());
    if(lines.length<2){alert('ãƒ‡ãƒ¼ã‚¿ãªã—');return}
    csvH=pLine(lines[0]);csvR=[];
    for(let i=1;i<lines.length;i++){const v=pLine(lines[i]);const o={};csvH.forEach((h,j)=>o[h.trim()]=v[j]||'');csvR.push(o)}
    setupCSV();
  };
  r.readAsText(file,enc);
}
function pLine(line){
  const r=[];let c='',q=false;
  for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){q=!q}else if(ch===','&&!q){r.push(c);c=''}else{c+=ch}}
  r.push(c);return r;
}
function setupCSV(){
  $('csvUI').style.display='block';
  $('csvSt').innerHTML=`<h4>${csvR.length}ä»¶ èª­è¾¼å®Œäº†</h4>`;
  ['cN','cD','cP','cDt','cSt'].forEach(id=>{
    const s=$(id);s.innerHTML='<option value="">-- é¸æŠ --</option>';
    csvH.forEach(h=>{const o=document.createElement('option');o.value=h.trim();o.textContent=h.trim();s.appendChild(o)});
  });
  csvH.forEach(h=>{
    const ht=h.trim();
    if(ht==='å•†å“å')$('cN').value=ht;
    if(ht==='èª¬æ˜'||ht==='èª¬æ˜æ–‡')$('cD').value=ht;
    if(ht==='ä¾¡æ ¼')$('cP').value=ht;
    if(ht==='çµ‚äº†æ—¥')$('cDt').value=ht;
    if(ht==='å‡ºå“çŠ¶æ³')$('cSt').value=ht;
  });
  const stCol=csvH.find(h=>h.trim()==='å‡ºå“çŠ¶æ³');
  if(stCol){
    const soldCnt=csvR.filter(r=>(r[stCol.trim()]||'').includes('å£²å´')).length;
    $('csvSt').innerHTML=`<h4>${csvR.length}ä»¶ èª­è¾¼å®Œäº†ï¼ˆã†ã¡å£²å´æ¸ˆ: ${soldCnt}ä»¶ï¼‰</h4>`;
  }
  const mc=Math.min(csvH.length,6);
  let h='<table><tr>';for(let i=0;i<mc;i++)h+=`<th>${esc(csvH[i].trim())}</th>`;h+='</tr>';
  for(let i=0;i<Math.min(csvR.length,5);i++){h+='<tr>';for(let j=0;j<mc;j++){const v=csvR[i][csvH[j].trim()]||'';h+=`<td title="${esc(v)}">${esc(v.substring(0,50))}</td>`}h+='</tr>'}
  h+='</table>';$('csvPv').innerHTML=h;
  $('btnGo').disabled=false;
}

// ================================================================
// OpenAI API
// ================================================================
async function testAPI(){
  const key=$('apiKey').value.trim();const model=$('mdl').value;const el=$('apiTestResult');
  if(!key){el.innerHTML='<span class="red">APIã‚­ãƒ¼ã‚’å…¥åŠ›</span>';return}
  el.innerHTML='ãƒ†ã‚¹ãƒˆä¸­...';
  try{
    const resp=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model,messages:[{role:'user',content:'Reply OK'}],max_tokens:10})
    });
    const data=await resp.json();
    if(data.error){el.innerHTML=`<span class="red">ã‚¨ãƒ©ãƒ¼: ${data.error.message}</span>`;return}
    if(data.choices?.[0])el.innerHTML=`<span class="grn">æ¥ç¶šOK (${model})</span>`;
    else el.innerHTML=`<span class="red">ä¸æ˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹</span>`;
  }catch(e){el.innerHTML=`<span class="red">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}</span>`}
}

let lastAPIError='';
async function callGPT(name,desc,key,model){
  const cleanDesc=(desc||'').replace(/<br\s*\/?>/gi,'\n').replace(/<[^>]*>/g,'').trim();

  const gpuKeys=Object.keys(gpuTable).join(', ');

  const prompt=`ä»¥ä¸‹ã®ãƒ¡ãƒ«ã‚«ãƒªPCå‡ºå“ã‚’è§£æã—ã¦JSONã§è¿”ã›ã€‚

å•†å“å: ${name||'ä¸æ˜'}
èª¬æ˜æ–‡:
${cleanDesc.substring(0,1500)}

ã€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
1. èª¬æ˜æ–‡ã®å…ˆé ­ï¼ˆâ˜†â˜…â˜†ã®å‰ï¼‰ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´ãŒæ›¸ã„ã¦ã‚ã‚‹å ´åˆã€ãã¡ã‚‰ãŒæœ€å„ªå…ˆã€‚
   ä¾‹:ã€ŒRyzen 7 5700X ã«å¤‰æ›´ã€â†’ cpuã¯"Ryzen 7 5700X"
   ä¾‹:ã€ŒSSD 1TB ã«å¤‰æ›´ã€â†’ ssdã¯"1TB"
   ä¾‹:ã€Œãƒ¡ãƒ¢ãƒª DDR4 32GBã€â†’ ramã¯"DDR4 32GB"
2. ã€Œã€œæŠœãã€ã¯é™¤å¤–ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æŠœãâ†’keyboard=nullã€ãƒ¢ãƒ‹ã‚¿ãƒ¼æŠœãâ†’monitor=nullï¼‰
3. ã€Œå˜å“ã€=æœ¬ä½“ã®ã¿ï¼ˆmonitor,keyboardã¨ã‚‚ã«nullï¼‰
4. ã€ŒCPUç„¡ã—ã€â†’ cpu=null
5. gpu_keyã¯ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã«æ­£è¦åŒ–: ${gpuKeys}
6. ramã¯å¿…ãšã€ŒDDR4 16GBã€ã€ŒDDR4 32GBã€ã€ŒDDR5 16GBã€ã€ŒDDR5 32GBã€ã€ŒDDR5 64GBã€ã®ã„ãšã‚Œã‹ã§è¿”ã™ã€‚DDRè¨˜è¼‰ãªã16GBã®ã¿ãªã‚‰ã€ŒDDR4 16GBã€ã¨ã™ã‚‹
7. optionã®æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«:
   - æ°´å†·/ç°¡æ˜“æ°´å†·â†’ã€Œç°¡æ˜“æ°´å†·ã€ã€æ¶²æ™¶æ°´å†·/æ¶²æ™¶ç°¡æ˜“æ°´å†·â†’ã€Œæ¶²æ™¶ç°¡æ˜“æ°´å†·ã€
   - WiFi/å†…è”µWi-Fi/WiFiå†…è”µâ†’ã€Œå†…è”µWiFiã€ã€USB WiFiâ†’ã€ŒUSB WiFiã€
   - Bluetooth/å†…è”µbluetoothâ†’ã€Œå†…è”µBluetoothã€ã€USB Bluetoothâ†’ã€ŒUSB Bluetoothã€
   - 120mmç©ºå†·ã‚¯ãƒ¼ãƒ©ãƒ¼â†’ã€Œ120mmç©ºå†·ã‚¯ãƒ¼ãƒ©ãƒ¼ã€ï¼ˆoptionã«å«ã‚ã‚‹ï¼‰
   - ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°
8. monitorã®åˆ¤å®š:
   - ãƒ¢ãƒ‹ã‚¿ãƒ¼ä»˜ãâ†’"ãƒ•ãƒ«HDãƒ¢ãƒ‹ã‚¿ãƒ¼"
   - 144hzãƒ¢ãƒ‹ã‚¿ãƒ¼ä»˜ãâ†’"144hzãƒ¢ãƒ‹ã‚¿ãƒ¼"ï¼ˆ144hz/165hz/240hzã®å ´åˆï¼‰
   - ãƒ¢ãƒ‹ã‚¿ãƒ¼æŠœã or å˜å“â†’null
9. keyboardã®åˆ¤å®š:
   - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹ä»˜ãâ†’"ã‚»ãƒƒãƒˆ"
   - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æŠœã or ãƒã‚¦ã‚¹æŠœã or å˜å“â†’null
   - ã€Œã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹ãƒ»ãƒã‚¦ã‚¹ãƒ‘ãƒƒãƒ‰æŠœãã€â†’null
   - ãƒ¢ãƒ‹ã‚¿ãƒ¼ã ã‘ä»˜ãã®å ´åˆâ†’keyboard=null
10. case_nameã®åˆ¤å®šãƒ«ãƒ¼ãƒ«ï¼ˆä»¥ä¸‹ã®å„ªå…ˆé †ä½ã§åˆ¤å®šï¼‰:
   - èª¬æ˜æ–‡ã«å…·ä½“çš„ãªã‚±ãƒ¼ã‚¹åï¼ˆCX200M,T4,H17,DS900WH,DS900BK,PIRAWH,CXWHç­‰ï¼‰ãŒã‚ã‚Œã°ãã‚Œã‚’è¿”ã™
   - ã‚¿ã‚¤ãƒˆãƒ«ãŒã€Œæ–°å“ã‚±ãƒ¼ã‚¹ã‚²ãƒ¼ãƒŸãƒ³ã‚°PCâ˜…ã€â†’ "æ–°å“ã‚±ãƒ¼ã‚¹â˜…"
   - ã‚¿ã‚¤ãƒˆãƒ«ãŒã€Œã€å³ç´æ¿€å®‰ãƒ›ãƒ¯ã‚¤ãƒˆãƒ¢ãƒ‡ãƒ«ã€‘ã€â†’ "ç™½ã‚±ãƒ¼ã‚¹"
   - ã‚¿ã‚¤ãƒˆãƒ«ãŒã€Œã€å³ç´æ¿€å®‰ãƒ–ãƒ©ãƒƒã‚¯ãƒ¢ãƒ‡ãƒ«ã€‘ã€â†’ "é»’ã‚±ãƒ¼ã‚¹"
   - ã‚¿ã‚¤ãƒˆãƒ«ãŒã€Œæ–°å“ã‚±ãƒ¼ã‚¹ã‚²ãƒ¼ãƒŸãƒ³ã‚°PCã€ï¼ˆâ˜…ãªã—ï¼‰â†’ "æ–°å“ã‚±ãƒ¼ã‚¹"
   - ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã€Œãƒ›ãƒ¯ã‚¤ãƒˆã‚±ãƒ¼ã‚¹ã€ã€Œãƒ–ãƒ©ãƒƒã‚¯ã®ã‚±ãƒ¼ã‚¹ã€ç­‰ã‚ã‚Œã°ãã¡ã‚‰ã‚’å„ªå…ˆ
   - ä¸Šè¨˜ã„ãšã‚Œã«ã‚‚è©²å½“ã—ãªã„å ´åˆ â†’ null

JSONå½¢å¼ï¼ˆä¸æ˜ã¯nullï¼‰:
{
  "gpu_key":"RTX3080",
  "gpu":"GeForce RTX3080",
  "cpu":"Ryzen 7 5700X",
  "ram":"DDR4 16GB",
  "ssd":"512GB",
  "mb":null,
  "monitor":"ãƒ•ãƒ«HDãƒ¢ãƒ‹ã‚¿ãƒ¼",
  "keyboard":"ã‚»ãƒƒãƒˆ",
  "case_name":null,
  "option":"ç°¡æ˜“æ°´å†·,å†…è”µWiFi",
  "is_fullset":true,
  "condition":"ãƒªãƒ•ã‚¡ãƒ¼ãƒ“ãƒƒã‚·ãƒ¥"
}

JSONã®ã¿è¿”ã›ã€‚`;

  try{
    const resp=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
      body:JSON.stringify({model,messages:[{role:'user',content:prompt}],temperature:0.1,max_tokens:600})
    });
    const data=await resp.json();
    if(data.error){lastAPIError=data.error.message;return null}
    const txt=data.choices?.[0]?.message?.content||'';
    if(!txt){lastAPIError='Empty response';return null}
    let j=txt.trim().replace(/^```json\s*/,'').replace(/\s*```$/,'');
    const fi=j.indexOf('{'),li=j.lastIndexOf('}');
    if(fi===-1||li===-1){lastAPIError='No JSON: '+j.substring(0,150);return null}
    j=j.substring(fi,li+1);
    lastAPIError='';return JSON.parse(j);
  }catch(e){lastAPIError=e.message;return null}
}

// ================================================================
// Single item processing (shared by URL fetch & manual add)
// ================================================================
async function processSingleItem(name,desc,price,date){
  const key=$('apiKey').value.trim();
  if(!key){alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return null}
  const model=$('mdl').value;
  const feeRate=parseInt($('defFee').value)||10;
  const defShip=parseInt($('defShip').value)||1500;

  let parts=null,parseError='';
  try{parts=await callGPT(name,desc,key,model)}catch(e){parseError=e.message}

  let gpuKey=null,costs={},missing=[];
  if(parts){
    gpuKey=parts.gpu_key?matchGpu(parts.gpu_key):matchGpu(parts.gpu);
    const result=calcCosts(parts,gpuKey);
    costs=result.costs;missing=result.missing;
  }

  const sale={
    id:Date.now(),product_name:name,description:desc,sale_price:price,date:date||'',
    parts:parts||{},gpuKey,costs,missing,
    shipping:defShip,fee_rate:feeRate,parseError
  };
  sales.push(sale);saveS();
  renderMissing();renderSales();
  return sale;
}

// ================================================================
// URL Fetch (CORS proxy)
// ================================================================
async function fetchURL(){
  const url=$('urlInput').value.trim();
  if(!url){$('urlSt').innerHTML='<span class="red">URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';return}
  if(!url.includes('mercari.com')){$('urlSt').innerHTML='<span class="red">ãƒ¡ãƒ«ã‚«ãƒªã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';return}

  $('btnURL').disabled=true;
  $('urlSt').innerHTML='å–å¾—ä¸­...';

  try{
    // Try multiple CORS proxies
    const proxies=[
      'https://corsproxy.io/?',
      'https://api.allorigins.win/raw?url=',
      'https://api.codetabs.com/v1/proxy?quest=',
    ];
    let html=null;
    for(const proxy of proxies){
      try{
        const resp=await fetch(proxy+encodeURIComponent(url),{signal:AbortSignal.timeout(12000)});
        if(resp.ok){html=await resp.text();if(html.length>500)break;html=null}
      }catch{}
    }
    if(!html){$('urlSt').innerHTML='<span class="red">å–å¾—å¤±æ•— â€” ãƒ—ãƒ­ã‚­ã‚·åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ‰‹å‹•è¿½åŠ ã‚’ãŠä½¿ã„ãã ã•ã„</span>';$('btnURL').disabled=false;return}

    let name='',price=0,desc='';

    // Method 1: __NEXT_DATA__ (Next.js â€” most reliable for Mercari)
    const ndMatch=html.match(/<script\s+id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
    if(ndMatch){
      try{
        const nd=JSON.parse(ndMatch[1]);
        // Navigate the Next.js data structure
        const props=nd.props?.pageProps;
        if(props){
          // Try common mercari data paths
          const item=props.item||props.product||props;
          if(item.name)name=item.name;
          if(item.price)price=parseInt(item.price)||0;
          if(item.description)desc=item.description;
          // Alternative nested structure
          if(!name&&item.itemName)name=item.itemName;
          if(!price&&item.itemPrice)price=parseInt(item.itemPrice)||0;
          if(!desc&&item.itemDescription)desc=item.itemDescription;
        }
      }catch{}
    }

    // Method 2: JSON-LD
    if(!name||!price){
      const ldMatches=html.matchAll(/<script\s+type="application\/ld\+json"[^>]*>([\s\S]*?)<\/script>/g);
      for(const m of ldMatches){
        try{
          const ld=JSON.parse(m[1]);
          const obj=Array.isArray(ld)?ld[0]:ld;
          if(obj['@type']==='Product'||obj['@type']==='IndividualProduct'){
            if(!name&&obj.name)name=obj.name;
            if(!desc&&obj.description)desc=obj.description;
            if(!price&&obj.offers){
              const off=Array.isArray(obj.offers)?obj.offers[0]:obj.offers;
              price=parseInt(off.price)||0;
            }
          }
        }catch{}
      }
    }

    // Method 3: OG meta tags
    const doc=new DOMParser().parseFromString(html,'text/html');
    if(!name){const el=doc.querySelector('meta[property="og:title"]');if(el)name=el.getAttribute('content')||''}
    if(!desc){const el=doc.querySelector('meta[property="og:description"]');if(el)desc=el.getAttribute('content')||''}
    if(!price){const el=doc.querySelector('meta[property="product:price:amount"]');if(el)price=parseInt(el.getAttribute('content'))||0}

    // Method 4: title tag
    if(!name){const el=doc.querySelector('title');if(el)name=el.textContent.replace(/\s*-\s*ãƒ¡ãƒ«ã‚«ãƒª.*$/,'').trim()}

    // Method 5: Regex on raw HTML for price
    if(!price){const m=html.match(/"price"\s*:\s*"?(\d+)"?/);if(m)price=parseInt(m[1])||0}
    if(!price){const m=html.match(/Â¥\s*([\d,]+)/);if(m)price=parseInt(m[1].replace(/,/g,''))||0}

    // Method 6: try to get description from script data
    if(!desc){
      const descMatch=html.match(/"description"\s*:\s*"((?:[^"\\]|\\.)*)"/);
      if(descMatch)desc=descMatch[1].replace(/\\n/g,'\n').replace(/\\"/g,'"').replace(/\\u[\dA-Fa-f]{4}/g,m=>String.fromCharCode(parseInt(m.slice(2),16)));
    }

    if(!name&&!price){
      $('urlSt').innerHTML='<span class="red">å•†å“æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•è¿½åŠ ã‚’ãŠä½¿ã„ãã ã•ã„</span>'
        +`<details class="mt8"><summary style="font-size:10px;cursor:pointer;color:#888">ãƒ‡ãƒãƒƒã‚°: HTMLå…ˆé ­500æ–‡å­—</summary><pre style="font-size:9px;max-height:200px;overflow:auto;background:#f5f5f0;padding:8px;border:1px solid #ddd">${esc(html.substring(0,500))}</pre></details>`;
      $('btnURL').disabled=false;return;
    }

    $('urlSt').innerHTML=`<span class="grn">å–å¾—æˆåŠŸ:</span> ${esc(name.substring(0,60))} / Â¥${price.toLocaleString()}<br><span style="color:#888">GPTè§£æä¸­...</span>`;

    const sale=await processSingleItem(name,desc,price,'');
    if(sale){
      const hasMiss=(sale.missing||[]).length>0;
      $('urlSt').innerHTML=`<span class="grn">âœ“ è¿½åŠ å®Œäº†</span> ${esc(name.substring(0,40))} / Â¥${price.toLocaleString()}`
        +(sale.parseError?` <span class="red">âš è§£æã‚¨ãƒ©ãƒ¼</span>`:'')
        +(hasMiss?` <span class="ylw">âš æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„${sale.missing.length}ä»¶</span>`:'');
      $('urlInput').value='';
    }
  }catch(e){
    $('urlSt').innerHTML=`<span class="red">ã‚¨ãƒ©ãƒ¼: ${e.message}</span>`;
  }
  $('btnURL').disabled=false;
}

// ================================================================
// Manual Entry
// ================================================================
async function manualAdd(){
  const name=$('manName').value.trim();
  const desc=$('manDesc').value.trim();
  const price=parseInt($('manPrice').value)||0;
  const date=$('manDate').value.trim();

  if(!name&&!desc){$('manSt').innerHTML='<span class="red">å•†å“åã‹èª¬æ˜æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';return}
  if(!price){$('manSt').innerHTML='<span class="red">å£²å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>';return}

  $('btnMan').disabled=true;
  $('manSt').innerHTML='GPTè§£æä¸­...';

  const sale=await processSingleItem(name,desc,price,date);
  if(sale){
    const hasMiss=(sale.missing||[]).length>0;
    $('manSt').innerHTML=`<span class="grn">âœ“ è¿½åŠ å®Œäº†</span>`
      +(sale.parseError?` <span class="red">âš è§£æã‚¨ãƒ©ãƒ¼: ${sale.parseError}</span>`:'')
      +(hasMiss?` <span class="ylw">âš æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„${sale.missing.length}ä»¶</span>`:'');
    $('manName').value='';$('manDesc').value='';$('manPrice').value='';$('manDate').value='';
  }
  $('btnMan').disabled=false;
}

// ================================================================
// AI Parse (CSV bulk)
// ================================================================
async function startAI(){
  const key=$('apiKey').value.trim();
  if(!key){alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return}
  if(!csvR.length){alert('CSVã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');return}
  const model=$('mdl').value;
  const cN=$('cN').value,cD=$('cD').value,cP=$('cP').value,cDt=$('cDt').value;
  const cSt=$('cSt').value;
  const soldOnly=$('soldOnly').checked;
  const defShip=parseInt($('defShip').value)||1500;
  const feeRate=(parseFloat($('feeRate').value)||10)/100;

  let targetRows=csvR;
  if(soldOnly&&cSt)targetRows=csvR.filter(r=>(r[cSt]||'').includes('å£²å´'));
  if(!targetRows.length){alert('å¯¾è±¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return}

  go(1);$('aiProg').style.display='block';$('aiRes').style.display='none';
  const newSales=[];

  for(let i=0;i<targetRows.length;i++){
    const row=targetRows[i];
    const nm=cN?row[cN]||'':'';
    const ds=cD?row[cD]||'':'';
    const pr=cP?parseInt(String(row[cP]).replace(/[,Â¥ï¿¥]/g,''))||0:0;
    const dt=cDt?row[cDt]||'':'';
    $('pBar').style.width=((i+1)/targetRows.length*100).toFixed(0)+'%';
    $('pTxt').textContent=`${i+1} / ${targetRows.length}`;
    $('pCur').textContent=nm.substring(0,50);

    let parts=null;lastAPIError='';
    try{if(nm||ds)parts=await callGPT(nm,ds,key,model)}catch(e){lastAPIError=e.message}

    // Match GPU and calculate costs
    let gpuKey=null;
    let costs={};
    let missing=[];

    if(parts){
      gpuKey=parts.gpu_key?matchGpu(parts.gpu_key):matchGpu(parts.gpu);
      const result=calcCosts(parts,gpuKey);
      costs=result.costs;
      missing=result.missing;
    }

    newSales.push({
      id:Date.now()+i,product_name:nm,description:ds,sale_price:pr,date:dt,
      parts:parts||{},gpuKey,costs,missing,
      shipping:defShip,fee_rate:feeRate,
      parseError:(!parts&&lastAPIError)?lastAPIError:''
    });
    if(i<targetRows.length-1)await new Promise(r=>setTimeout(r,400));
  }

  sales=[...sales,...newSales];saveS();
  $('aiProg').style.display='none';$('aiRes').style.display='block';
  $('b1').textContent=sales.length;
  let mc=newSales.reduce((s,x)=>(x.missing||[]).length+s,0);
  let errCnt=newSales.filter(s=>s.parseError).length;
  $('b2').textContent=mc;
  $('aiSt').innerHTML=`<h4>${newSales.length}ä»¶ã®è§£æå®Œäº†</h4>`
    +(errCnt>0?`<p class="red" style="font-weight:700">âš  ${errCnt}ä»¶ã§APIè§£æå¤±æ•—</p>`:'')
    +(mc>0?`<p class="ylw" style="font-weight:700">âš  ${mc}ä»¶ã®æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„ã‚ã‚Š â†’ ä¸è¶³ãƒ‘ãƒ¼ãƒ„ã‚¿ãƒ–ã§åŸä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>`:'<p class="grn">å…¨ãƒ‘ãƒ¼ãƒ„ãƒãƒƒãƒæ¸ˆã¿</p>');

  if(errCnt>0){
    const fe=newSales.find(s=>s.parseError);
    $('aiSt').innerHTML+=`<div class="al al-e mt8"><h4>ã‚¨ãƒ©ãƒ¼è©³ç´°</h4><p>${esc(fe.parseError)}</p></div>`;
  }

  // Result list
  let html='';
  newSales.forEach(s=>{
    const gpu=s.parts?.gpu||'â€”';const cpu=s.parts?.cpu||'â€”';
    const gk=s.gpuKey||'ä¸æ˜';
    const hasErr=!!s.parseError;
    const hm=(s.missing||[]).length>0;
    html+=`<div class="sr" ${hasErr?'style="border-left:3px solid #c44"':hm?'style="border-left:3px solid #e6a800"':''}>
      <div class="sr-h"><div class="sr-nm"><div class="sr-nm-t">${esc(s.product_name||'â€”')}</div>
      <div class="sr-nm-s">${hasErr?'<span class="red">è§£æå¤±æ•—</span>':gpu+' / '+cpu+' / GPU: '+gk}</div></div>
      <div class="sr-n"><div><div class="sr-nl">å£²å€¤</div><div class="sr-nv">Â¥${(s.sale_price||0).toLocaleString()}</div></div>
      <div><div class="sr-nl">åŸä¾¡</div><div class="sr-nv">Â¥${totalCost(s.costs).toLocaleString()}</div></div>
      ${hasErr?'<span class="tag tag-m">ã‚¨ãƒ©ãƒ¼</span>':hm?'<span class="tag tag-m">æœªç™»éŒ²'+s.missing.length+'ä»¶</span>':'<span class="tag tag-g">OK</span>'}</div></div></div>`;
  });
  $('aiList').innerHTML=html;
}

// ================================================================
// Missing Parts
// ================================================================
let pendingMissing=[];
function renderMissing(){
  // Collect all unique missing parts across all sales
  const allMiss=[];
  const seen=new Set();
  sales.forEach(s=>{
    (s.missing||[]).forEach(m=>{
      const key=m.cat+':'+m.name;
      if(!seen.has(key)){seen.add(key);allMiss.push({...m,key})}
    });
  });
  pendingMissing=allMiss;
  $('b2').textContent=allMiss.length;
  if(!allMiss.length){$('missWrap').innerHTML='<div class="al al-s"><h4>æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„ãªã— â€” ã™ã¹ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒãƒƒãƒæ¸ˆã¿</h4></div>';return}

  const catLabels={gpu:'GPU',cpu:'CPU',ram:'RAM',ssd:'SSD',cas:'ã‚±ãƒ¼ã‚¹',option:'ã‚ªãƒ—ã‚·ãƒ§ãƒ³'};
  let html='<div class="al al-w"><h4>ä»¥ä¸‹ã®ãƒ‘ãƒ¼ãƒ„ãŒãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªç™»éŒ²ã§ã™</h4><p>åŸä¾¡ã‚’å…¥åŠ›ã—ã¦ã€Œé©ç”¨ã—ã¦å£²ä¸Šã¸ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p></div>';
  allMiss.forEach((m,i)=>{
    html+=`<div class="cd" style="padding:14px 20px">
      <div class="row fx-c">
        <div style="flex:2"><span class="tag tag-m">${catLabels[m.cat]||m.cat}</span> <strong>${esc(m.name)}</strong> <span style="font-size:11px;color:#888">${esc(m.note||'')}</span></div>
        <div style="flex:1"><label>åŸä¾¡ Â¥</label><input type="number" id="missP_${i}" placeholder="åŸä¾¡ã‚’å…¥åŠ›" style="font-size:14px;padding:8px"></div>
      </div>
    </div>`;
  });
  $('missWrap').innerHTML=html;
}

function applyMissing(){
  try{
  if(!pendingMissing.length){go(3);return}
  let added=0;

  // Safety init
  if(!optPrices.cpu)optPrices.cpu={};
  if(!optPrices.ram)optPrices.ram={};
  if(!optPrices.ssd)optPrices.ssd={};
  if(!optPrices.cas)optPrices.cas={};
  if(!optPrices.other)optPrices.other={};

  pendingMissing.forEach((m,i)=>{
    const priceEl=$('missP_'+i);
    if(!priceEl)return;
    const price=parseInt(priceEl.value);
    if(isNaN(price))return;

    if(m.cat==='cpu'){
      let short=m.name.replace(/ryzen\s*(7|9|5)\s*/i,'').replace(/core\s*i\d\s*/i,'').trim();
      if(!short)short=m.name;
      optPrices.cpu[short]=price;
      added++;
    } else if(m.cat==='ram'){
      optPrices.ram[m.name]=price;
      added++;
    } else if(m.cat==='ssd'){
      optPrices.ssd[m.name]=price;
      added++;
    } else if(m.cat==='cas'){
      optPrices.cas[m.name]=price;
      added++;
    } else if(m.cat==='option'){
      optPrices.other[m.name]=price;
      added++;
    } else if(m.cat==='gpu'){
      gpuTable[m.name]={gpu:price,cpu:3500,mb:4000,ram:8000,ssd:7000,cas:7000,psu:700,cool:300};
      added++;
    }
  });

  if(added>0){
    localStorage.setItem(LS_GPU,JSON.stringify(gpuTable));
    localStorage.setItem(LS_OPT,JSON.stringify(optPrices));
    renderGpuTable();renderAllPartTables();

    // Recalculate all sales
    sales.forEach(s=>{
      if(!s.parts||!Object.keys(s.parts).length)return;
      const gpuKey=s.parts.gpu_key?matchGpu(s.parts.gpu_key):matchGpu(s.parts.gpu);
      const result=calcCosts(s.parts,gpuKey);
      s.gpuKey=gpuKey;
      s.costs=result.costs;
      s.missing=result.missing;
    });
    saveS();
  }

  go(3);
  }catch(e){alert('é©ç”¨ã‚¨ãƒ©ãƒ¼: '+e.message);console.error(e)}
}

// ================================================================
// Sales Rendering
// ================================================================
function renderSales(){
  let totalSale=0,totalProfit=0,totalTax=0,cnt=0;
  let html='';
  sales.forEach((s,idx)=>{
    const p=calcProfit(s);
    totalSale+=s.sale_price;totalProfit+=p.profit;totalTax+=p.tax;cnt++;
    const pRate=(p.profitRate*100).toFixed(1);

    const costParts=[
      ['GPU',s.parts?.gpu||s.gpuKey||'â€”',s.costs?.gpu],
      ['CPU',s.parts?.cpu||'ãƒ™ãƒ¼ã‚¹',s.costs?.cpu],
      ['MB','A520',s.costs?.mb],
      ['RAM',s.parts?.ram||'16GB',s.costs?.ram],
      ['SSD',s.parts?.ssd||'512GB',s.costs?.ssd],
      ['ã‚±ãƒ¼ã‚¹',s.parts?.case_name||'æ¨™æº–',s.costs?.cas],
      ['é›»æº','â€”',s.costs?.psu],
      ['ã‚¯ãƒ¼ãƒ©ãƒ¼','â€”',s.costs?.cool],
      ['ãƒ¢ãƒ‹ã‚¿ãƒ¼',s.parts?.monitor||'ãªã—',s.costs?.monitor],
      ['KB+ãƒã‚¦ã‚¹',s.parts?.keyboard||'ãªã—',s.costs?.keyboard],
      ['ã‚ªãƒ—ã‚·ãƒ§ãƒ³',s.parts?.option||'ãªã—',s.costs?.option],
    ];

    html+=`<div class="sr">
      <div class="sr-h" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
        <div class="sr-nm">
          <div class="sr-nm-t">${esc(s.product_name||'â€”')}</div>
          <div class="sr-nm-s">${esc(s.gpuKey||'â€”')} / ${esc(s.parts?.cpu||'â€”')} / ${s.parts?.is_fullset?'ãƒ•ãƒ«ã‚»ãƒƒãƒˆ':'æœ¬ä½“ã®ã¿'}</div>
        </div>
        <div class="sr-n">
          <div><div class="sr-nl">å£²å€¤</div><div class="sr-nv">Â¥${s.sale_price.toLocaleString()}</div></div>
          <div><div class="sr-nl">åŸä¾¡</div><div class="sr-nv">Â¥${p.costTotal.toLocaleString()}</div></div>
          <div><div class="sr-nl">åˆ©ç›Š</div><div class="sr-nv grn">Â¥${p.profit.toLocaleString()}</div></div>
          <div><div class="sr-nl">åˆ©ç›Šç‡</div><div class="sr-nv">${pRate}%</div></div>
          <div style="cursor:pointer;font-size:16px;color:#888">â–¼</div>
        </div>
      </div>
      <div class="sr-d" style="display:none">
        <div class="pg">`;
    const missCats=new Set((s.missing||[]).map(m=>m.cat));
    costParts.forEach(([label,name,cost])=>{
      const isMiss=(label==='GPU'&&missCats.has('gpu'))||(label==='CPU'&&missCats.has('cpu'))||(label==='RAM'&&missCats.has('ram'))||(label==='SSD'&&missCats.has('ssd'))||(label==='ã‚±ãƒ¼ã‚¹'&&missCats.has('cas'))||(label==='ã‚ªãƒ—ã‚·ãƒ§ãƒ³'&&missCats.has('option'));
      html+=`<div class="pc${isMiss?' miss':''}"><div class="pc-l">${label}${isMiss?' <span class="red">âš æœªç™»éŒ²</span>':''}</div><div class="pc-n" title="${esc(name)}">${esc(name)}</div><div class="mono" style="font-size:11px">Â¥${(cost||0).toLocaleString()}</div></div>`;
    });
    html+=`</div>
        ${(s.missing||[]).length>0?`<div class="al al-w mt8"><h4>æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„ ${s.missing.length}ä»¶</h4><p>${s.missing.map(m=>m.name).join(', ')} â†’ ä¸è¶³ãƒ‘ãƒ¼ãƒ„ã‚¿ãƒ–ã§åŸä¾¡å…¥åŠ›</p></div>`:''}
        <div class="mt8" style="font-size:11px;color:#888">æ‰‹æ•°æ–™: Â¥${p.fee.toLocaleString()} / é€æ–™: Â¥${s.shipping.toLocaleString()} / æ¶ˆè²»ç¨: Â¥${p.tax.toLocaleString()}</div>
        <details class="mt8"><summary style="font-size:11px;color:#888;cursor:pointer">èª¬æ˜æ–‡</summary><pre style="font-size:10px;color:#666;white-space:pre-wrap;max-height:200px;overflow-y:auto;margin-top:6px">${esc((s.description||'').replace(/<br\s*\/?>/gi,'\n').replace(/<[^>]*>/g,''))}</pre></details>
        <div class="mt8"><button class="btn btn-d" style="padding:4px 12px;font-size:11px" onclick="sales.splice(${idx},1);saveS();renderSales()">å‰Šé™¤</button></div>
      </div>
    </div>`;
  });

  // Global missing count
  const globalMiss=sales.reduce((s,x)=>(x.missing||[]).length+s,0);
  $('b2').textContent=globalMiss;
  let missHtml=globalMiss>0?`<div class="al al-w mb16"><h4>æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„ ${globalMiss}ä»¶</h4><p>ä¸è¶³ãƒ‘ãƒ¼ãƒ„ã‚¿ãƒ–ã§åŸä¾¡ã‚’å…¥åŠ›ã—ã¦å†è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚æœªç™»éŒ²ãƒ‘ãƒ¼ãƒ„ã®åŸä¾¡ã¯ãƒ™ãƒ¼ã‚¹å€¤ã®ã¾ã¾è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™ã€‚</p></div>`:'';

  $('salesList').innerHTML=missHtml+html;
  $('s1').textContent='Â¥'+totalSale.toLocaleString();
  $('s2').textContent='Â¥'+totalProfit.toLocaleString();
  $('s3').textContent=cnt>0?((totalProfit/totalSale*100).toFixed(1)+'%'):'0%';
  $('s4').textContent='Â¥'+totalTax.toLocaleString();
  $('b1').textContent=sales.length;
}

// ================================================================
// Excel Export
// ================================================================
function toExcel(){
  if(!sales.length){alert('ãƒ‡ãƒ¼ã‚¿ãªã—');return}
  const hd=['å•†å“å','GPUå‹ç•ª','GPU','CPU','MB','RAM','SSD','ã‚±ãƒ¼ã‚¹','é›»æº','ã‚¯ãƒ¼ãƒ©ãƒ¼','ãƒ¢ãƒ‹ã‚¿ãƒ¼','KB+ãƒã‚¦ã‚¹','ã‚ªãƒ—ã‚·ãƒ§ãƒ³',
    'GPUåŸä¾¡','CPUåŸä¾¡','MBåŸä¾¡','RAMåŸä¾¡','SSDåŸä¾¡','ã‚±ãƒ¼ã‚¹åŸä¾¡','é›»æºåŸä¾¡','ã‚¯ãƒ¼ãƒ©ãƒ¼åŸä¾¡','ãƒ¢ãƒ‹ã‚¿ãƒ¼åŸä¾¡','KB+ãƒã‚¦ã‚¹åŸä¾¡','OPåŸä¾¡',
    'æœ¬ä½“åˆè¨ˆ','å£²å€¤','æ‰‹æ•°æ–™ç‡','æ‰‹æ•°æ–™','é€æ–™','æ¶ˆè²»ç¨','åˆ©ç›Š','åˆ©ç›Šç‡','ãƒ•ãƒ«ã‚»ãƒƒãƒˆ','çŠ¶æ…‹','æ—¥ã«ã¡'];
  const rows=[hd];
  sales.forEach(s=>{
    const p=calcProfit(s);
    const c=s.costs||{};
    rows.push([
      s.product_name,s.gpuKey||'',s.parts?.gpu||'',s.parts?.cpu||'','A520',s.parts?.ram||'',s.parts?.ssd||'',s.parts?.case_name||'',
      '','',s.parts?.monitor||'',s.parts?.keyboard||'',s.parts?.option||'',
      c.gpu||0,c.cpu||0,c.mb||0,c.ram||0,c.ssd||0,c.cas||0,c.psu||0,c.cool||0,c.monitor||0,c.keyboard||0,c.option||0,
      p.costTotal,s.sale_price,s.fee_rate,p.fee,s.shipping,p.tax,p.profit,(p.profitRate*100).toFixed(1)+'%',
      s.parts?.is_fullset?'â—‹':'Ã—',s.parts?.condition||'',s.date||''
    ]);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'å£²ä¸Šåˆ©ç›Šä¸€è¦§');

  // GPUãƒ†ãƒ¼ãƒ–ãƒ«ã‚·ãƒ¼ãƒˆ
  const gt=[['GPUå‹ç•ª','ã‚°ãƒ©ãƒœ','CPU','MB','RAM','SSD','ã‚±ãƒ¼ã‚¹','é›»æº','ã‚¯ãƒ¼ãƒ©ãƒ¼','åˆè¨ˆ']];
  for(const[k,v]of Object.entries(gpuTable)){
    const t=v.gpu+v.cpu+v.mb+v.ram+v.ssd+v.cas+v.psu+v.cool;
    gt.push([k,v.gpu,v.cpu,v.mb,v.ram,v.ssd,v.cas,v.psu,v.cool,t]);
  }
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(gt),'GPUãƒ†ãƒ¼ãƒ–ãƒ«');

  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet([
    ['ç·å£²ä¸Š','ç·åˆ©ç›Š','æ¶ˆè²»ç¨åˆè¨ˆ','ä»¶æ•°'],
    [sales.reduce((s,x)=>s+x.sale_price,0),sales.reduce((s,x)=>s+calcProfit(x).profit,0),sales.reduce((s,x)=>s+calcProfit(x).tax,0),sales.length]
  ]),'ã‚µãƒãƒªãƒ¼');

  XLSX.writeFile(wb,`TITAN_åˆ©ç›Š_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// ================================================================
// Init
// ================================================================
// Init
loadAllTables();
loadS();
loadSettings();
renderGpuTable();
renderAllPartTables();
$('b1').textContent=sales.length;
</script>
</body>
</html>
